{%liquid
    assign brandsInCart = cart.items | map: 'vendor' | uniq | join: ','
    assign itemsInCart = cart.items | map: 'product_id' | uniq | join: ','
    assign upsellProducts = ""
    for product in collections.all.products
        if product.tags contains 'Upsell' and brandsInCart contains product.vendor
            unless itemsInCart contains product.id
                assign upsellProducts = upsellProducts | append: product.handle | append: ","
            endunless
        endif
    endfor
    assign upsellProducts = upsellProducts | split: ","
%}
{% if upsellProducts.size > 0 %}
    {% render 'inline__crosssell', p1: all_products[upsellProducts[0]], p2: all_products[upsellProducts[1]], p3: all_products[upsellProducts[2]], heading: "Add-on Items" %}
{% endif %}
